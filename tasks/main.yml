---
- name: update repo cache (debian)
  become: yes
  apt: 
    update_cache: yes
  when: ansible_facts['os_family'] == "Debian"

- name: install updates (debian)
  become: yes
  apt: 
    name: "*"
    state: latest
  when: ansible_facts['os_family'] == "Debian"

- name: add username to sudoers
  become: yes
  template: 
    src: sudoers.j2
    dest: "/etc/sudoers.d/{{ sudoers_user }}"
    owner: root
    group: root
    mode: 440

- name: install required packages
  become: yes
  apt: 
    name: 
      - ansible
      - docker
      - docker.io
      - python3
      - python3-docker
      - python3-ldap
      - maven
      - vim 
      - screen
      - git
      - openconnect
    state: latest
  when: ansible_facts['os_family'] == "Debian"

- name: create docker group
  become: yes
  group: 
    name: docker
    state: present

- name: "add {{ sudoers_user }} to docker group"
  become: yes
  user: 
    name: "{{ sudoers_user }}"
    group: "{{ sudoers_user }}"
    groups: docker
    append: yes

- name: "copy git config"
  copy:
    src: gitconfig
    dest: "/home/{{ sudoers_user }}/.gitconfig"
    decrypt: yes
    owner: "{{ sudoers_user }}"
    group: "{{ sudoers_user }}"
    mode: '0644'

- name: "copy git credentials"
  copy:
    src: git-credentials
    dest: "/home/{{ sudoers_user }}/.git-credentials"
    decrypt: yes
    owner: "{{ sudoers_user }}"
    group: "{{ sudoers_user }}"
    mode: '0600'

- name: "ajout alias inspq pour globalprotect"
  lineinfile:
    path: "/home/{{ sudoers_user }}/.bashrc"
    line: "alias inspq='sudo openconnect --protocol=gp www.portail.rtss.qc.ca -u marroc28'"
    create: yes

- name: "Log into private registry and force re-authorization as user {{ sudoers_user }}"
  cmd: docker login nexus3.inspq.qc.ca:5000 --username admin --password admin123

- name: "Log into private registry and force re-authorization as root"
  cmd: docker login nexus3.inspq.qc.ca:5000 --username admin --password admin123
  become: yes
  become_user: root
    